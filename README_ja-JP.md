# pilcrow

**pilcrow** は、長文テキストを構造化された段落に整形して読みやすくするコマンドラインツールです。大規模言語モデル（LLM）を活用して、文章中の新しい段落の開始位置を自動で検出し、空行を挿入してテキストを再構成します。

このツールは、音声書き起こしの可読性を向上させたいというニーズから開発されました。会話の書き起こしは、適切な段落分けがされていないことが多く、読みづらい形式になりがちです。

## 特長

- **段落の自動再構成**  
  会話の切れ目（段落の開始位置）を自動的に検出し、テキストを再構成します。

- **LLMによる処理**  
  `ollama` インターフェースを通じて LLM を利用し、長文テキストの分析と分割を行います。

- **柔軟なカスタマイズ**  
  検出の試行回数の指定、特定の接頭辞で始まる行の除外、詳細なログ出力など、さまざまなオプションに対応しています。

- **簡単な導入と実行**  
  [pipx](https://pipxproject.github.io/pipx/) を用いてインストール・実行が可能です。

## インストール方法

`pilcrow` を使用するには、事前に [Ollama](https://ollama.com/) をインストールしておく必要があります。詳細は公式サイトの手順をご参照ください。

その後、以下のように `pipx` を使って GitHub から直接インストールできます：

```bash
pipx install git+https://github.com/tos-kamiya/pilcrow
```

あるいは、次の手順で `pip` を用いたインストールも可能です：

```bash
git clone https://github.com/tos-kamiya/pilcrow
cd pilcrow
pip install .
```

## 使い方

インストール後は、コマンドラインから `pilcrow` を実行できます。使用例を以下に示します：

* **基本的な使い方：**

  ```bash
  pilcrow input.txt
  ```

* **標準入力を使用する場合：**

  ```bash
  cat transcript.txt | pilcrow -
  ```

* **特定の接頭辞を持つ行を除外する場合：**

  ```bash
  pilcrow input.txt --skip-line-prefix="---" --skip-line-prefix="###"
  ```

* **複数回の検出をマージ（例：5回の多数決）：**

  ```bash
  pilcrow input.txt --trials 5
  ```

* **詳細ログの出力：**

  ```bash
  pilcrow input.txt --verbose
  ```

* **出力ファイルの指定方法：**

  `-o` で出力ファイル名を指定：

  ```bash
  pilcrow input.txt -o output.txt
  ```

  または、`-O` を使うと入力ファイル名に `-pilcrow` を付けた出力ファイル名が自動生成されます
  （※ 標準入力と併用はできません）：

  ```bash
  pilcrow input.txt -O
  ```

### コマンドライン引数・オプション

* **`input_file`**
  入力用の書き起こしテキストファイル。`-` を指定すると標準入力から読み込みます。

* **`--skip-line-prefix`**
  指定した接頭辞で始まる行を検出対象から除外します。複数回指定可能です。

* **`--trials`**
  段落検出を行う試行回数（デフォルトは1）。2回以上指定した場合、多数決で結果をマージします。

* **`--verbose`**
  詳細なログメッセージを標準エラーに出力します（"Info:" 付き）。

* **`-o/--output`**
  明示的に出力ファイル名を指定します。

* **`-O/--auto-output`**
  入力ファイル名に `-pilcrow` を付けた出力ファイル名を自動生成します。
  `-o` とは併用不可で、標準入力と一緒に使うこともできません。

## 例

デモ用に作成された開発者のメモを想定した人工的な例です。

```bash
$ cat sample1-j.txt
通知モジュールのリファクタリングが完了。今は新しいイベントバスのインターフェースを使うようにした。非同期動作に対応するために、いくつかのリスナーも更新する必要があった。それと、再デプロイ後にスケジュールされたジョブが二重に実行されるバグも修正。原因は、コンテナの初期化スクリプト内のcron設定ミスだった。レガシーなXML設定ファイルのサポートを切るかどうかはまだ検討中。保守が面倒だけど、今もそれに依存しているクライアントが1件ある。メトリクスコレクタが正しくPrometheusのエンドポイントにデータを送っているか確認する必要あり。Grafanaのダッシュボードが先週から更新されていない。明日の朝にPR #214をレビューする予定。見た感じは単純だけど、ロールバック処理の確認はしておきたい。モバイル側のフローのテストにはまだ手が回っていない。たぶん明日やる。

$ cat sample1-j.txt | pilcrow -

通知モジュールのリファクタリングが完了。
今は新しいイベントバスのインターフェースを使うようにした。
非同期動作に対応するために、いくつかのリスナーも更新する必要があった。
それと、再デプロイ後にスケジュールされたジョブが二重に実行されるバグも修正。
原因は、コンテナの初期化スクリプト内のcron設定ミスだった。

レガシーなXML設定ファイルのサポートを切るかどうかはまだ検討中。
保守が面倒だけど、今もそれに依存しているクライアントが1件ある。

メトリクスコレクタが正しくPrometheusのエンドポイントにデータを送っているか確認する必要あり。
Grafanaのダッシュボードが先週から更新されていない。

明日の朝にPR #214をレビューする予定。
見た感じは単純だけど、ロールバック処理の確認はしておきたい。

モバイル側のフローのテストにはまだ手が回っていない。
たぶん明日やる。
```

## ライセンス

MIT
